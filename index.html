<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input Nilai SAS Ganjil 2025/2026 - Malika IBS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Dark mode base */
            color: #e0e0e0; /* Light grey text */
            overflow-x: hidden;
        }
        
        .running-text-container {
            width: 100%;
            background-color: #007AFF; /* Biru terang solid */
            color: #FFFFFF; /* Teks warna putih */
            font-weight: 500;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 50;
        }
        .running-text p {
            margin: 0;
            padding: 8px 0;
            white-space: nowrap;
            display: inline-block;
            animation: marquee 35s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }

        /* Custom Card Style */
        .card {
            background-color: rgba(29, 29, 31, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease-in-out;
            color: #e0e0e0;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.15);
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn:disabled {
            background-image: none;
            background-color: #333333;
            color: #888888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-primary {
            background-image: linear-gradient(135deg, #007AFF, #005AF0);
        }
        .btn-primary:not(:disabled):hover {
            box-shadow: 0 10px 15px -3px rgb(0 122 255 / 0.3);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-image: linear-gradient(135deg, #34C759, #28A745);
        }
        .btn-secondary:hover {
            box-shadow: 0 10px 15px -3px rgb(52 199 89 / 0.3);
            transform: translateY(-2px);
        }
        
        /* Inputs */
        select, input.grade-input {
            background-color: rgba(50, 50, 50, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #e0e0e0;
            transition: all 0.2s;
        }
        select:focus, input.grade-input:focus {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
            background-color: rgba(60, 60, 60, 0.9);
            outline: none;
        }
        
        /* Gradient Text */
        .gradient-text-apple {
            background: linear-gradient(to right, #5AC8FA, #BF5AF2, #FF2D55);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Table */
        .table-header-dark {
            background-color: #1a1a1a;
            color: #ffffff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .table-row-dark {
            background-color: rgba(29, 29, 31, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease;
        }
        .table-row-dark:hover {
            background-color: rgba(40, 40, 42, 0.6);
        }
        
        /* Active Row Highlight */
        .table-row-dark.active-row {
            background-color: rgba(0, 122, 255, 0.15) !important;
            border-left: 4px solid #007AFF;
        }

        /* Modal */
        #preview-modal .modal-content {
            background-color: rgba(29, 29, 31, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }
        #preview-modal .border-b, #preview-modal .border-t {
            border-color: rgba(255, 255, 255, 0.1);
        }
        #preview-modal .modal-footer {
            background-color: rgba(20, 20, 22, 0.8);
        }

        /* Toast */
        #toast {
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="pb-20">
    
    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative z-10">
        
        <!-- Header -->
        <header class="bg-black/40 backdrop-blur-lg rounded-xl shadow-md p-6 mb-8 flex flex-col md:flex-row items-center gap-6 border border-white/10">
            <img src="https://iili.io/FsLlXA7.png" alt="Logo Malika Islamic Boarding School" class="h-20 w-20 rounded-full object-cover border-2 border-white/20">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                    Sistem <span class="gradient-text-apple">Input Nilai SAS Ganjil 2025/2026</span>
                </h1>
                <p class="text-white/70 text-lg">Malika Islamic Boarding School</p>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Input Forms -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Step 1: Selection Form -->
                <div id="selection-form" class="card p-8">
                    <h2 class="text-xl font-bold mb-6 border-b border-white/10 pb-3 text-white">1. Pilih Detail Kelas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="school-level" class="block text-sm font-medium text-white/80 mb-2">Jenjang</label>
                            <select id="school-level" class="w-full p-3 rounded-lg shadow-sm">
                                <option value="">Pilih Jenjang...</option>
                                <option value="SMP">SMP</option>
                                <option value="SMA">SMA</option>
                            </select>
                        </div>
                        <div>
                            <label for="class-name" class="block text-sm font-medium text-white/80 mb-2">Kelas</label>
                            <select id="class-name" class="w-full p-3 rounded-lg shadow-sm" disabled>
                                <option>Pilih Jenjang Dulu</option>
                            </select>
                        </div>
                        <div>
                            <label for="subject" class="block text-sm font-medium text-white/80 mb-2">Mata Pelajaran</label>
                            <select id="subject" class="w-full p-3 rounded-lg shadow-sm" disabled>
                                <option>Pilih Jenjang Dulu</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button id="start-input-btn" class="btn btn-primary" disabled>
                            Mulai Input Nilai &rarr;
                        </button>
                    </div>
                </div>

                <!-- Step 2: Grade Input Table -->
                <div id="grade-input-section" class="card p-8 hidden">
                    <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-3">
                        <div>
                            <h2 class="text-xl font-bold text-white">2. Input Nilai Santri</h2>
                            <p id="grade-input-header" class="text-white/70"></p>
                        </div>
                        <button id="change-selection-btn" class="text-sm font-semibold text-blue-400 hover:text-blue-300 transition">Ubah Pilihan</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-full text-sm text-left text-white/80">
                            <thead class="text-xs uppercase table-header-dark">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg w-16">No.</th>
                                    <th scope="col" class="px-6 py-3">Nama Santri</th>
                                    <th scope="col" class="px-6 py-3 rounded-r-lg w-40 text-center">Nilai</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-8 text-right">
                        <button id="preview-btn" class="btn btn-secondary">
                            Preview Nilai
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Info & Stats -->
            <div class="space-y-6">
                <div class="card p-6 sticky top-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-white/10 pb-2">Statistik Kelas</h3>
                    <div class="space-y-4">
                        <div class="bg-white/5 p-4 rounded-lg">
                            <p class="text-xs text-white/60 mb-1">Rata-rata Nilai</p>
                            <p id="stat-avg" class="text-2xl font-bold text-blue-400">-</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/5 p-4 rounded-lg">
                                <p class="text-xs text-white/60 mb-1">Tertinggi</p>
                                <p id="stat-max" class="text-xl font-bold text-green-400">-</p>
                            </div>
                            <div class="bg-white/5 p-4 rounded-lg">
                                <p class="text-xs text-white/60 mb-1">Terendah</p>
                                <p id="stat-min" class="text-xl font-bold text-red-400">-</p>
                            </div>
                        </div>
                        <div class="bg-white/5 p-4 rounded-lg">
                            <p class="text-xs text-white/60 mb-1">Status Pengisian</p>
                            <p class="text-sm font-medium text-white"><span id="stat-filled">0</span> / <span id="stat-total">0</span> Santri</p>
                            <div class="w-full bg-gray-700 rounded-full h-1.5 mt-2">
                                <div id="stat-progress" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-white/10">
                        <p class="text-xs text-white/50 italic">
                            * Info: Masukkan angka 10-100. Jika santri belum ujian, masukkan tanda strip (-).
                        </p>
                    </div>
                </div>
            </div>

        </div> 
    </div>

    <!-- Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0 duration-300">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Konfirmasi Input Nilai</h3>
                <button id="close-modal-btn" class="text-white/50 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto">
                <div id="preview-details" class="mb-6 space-y-2 text-white/90"></div>
                <div class="overflow-x-auto border rounded-lg border-white/10">
                    <table class="w-full text-sm text-left text-white/80">
                        <thead class="text-xs uppercase table-header-dark">
                            <tr>
                                <th scope="col" class="px-6 py-3 w-16">No.</th>
                                <th scope="col" class="px-6 py-3">Nama Santri</th>
                                <th scope="col" class="px-6 py-3 w-24 text-center">Nilai</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-6 modal-footer rounded-b-xl flex flex-col md:flex-row justify-end gap-4 border-t">
                <button id="cancel-btn" class="py-3 px-6 rounded-lg font-bold bg-white/10 text-white/80 hover:bg-white/20 transition-colors">
                    Kembali & Edit
                </button>
                <button id="confirm-submit-btn" class="btn btn-primary flex items-center justify-center gap-2">
                    <span id="submit-text">Konfirmasi & Kirim</span>
                    <span id="submit-spinner" class="hidden">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[150%]"></div>

    <!-- Running Text -->
    <div class="running-text-container">
        <div class="running-text">
            <p>Setiap ketukan jari Ustadz dan Ustadzah hari ini, adalah investasi kita bersama untuk pemimpin masa depan. Terima kasih atas dedikasi tanpa batas #SalamKangenJalanJalanLagi ðŸ›µ ðŸ›« ðŸšŒ ðŸ˜Ž  &nbsp;&nbsp;&nbsp;&nbsp; Setiap ketukan jari Ustadz dan Ustadzah hari ini, adalah investasi kita bersama untuk pemimpin masa depan. Terima kasih atas dedikasi tanpa batas #SalamKangenJalanJalanLagi . &nbsp;&nbsp;&nbsp;&nbsp;</p>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const schoolData = {
        SMP: {
            classes: {
                'Kelas 7 A Putra': ["Athariz Chalief Saputra", "Ahmad Khomaini", "Al Athar Ghaizan Nobel", "Alzabar Akbar", "Arya Devano", "Abyan Dzaky Hafizh Kurniawan", "Fadil Syafif Nugroho Sukri", "Fakhri Muhammad Mumtaz", "I Komang Raditiya Novian Pradana Putra", "Ibad Najwan", "Ibni Shidqie Al Mumtazhar", "Kenzie Dastan Shalahuddin Zan", "Khaerul A'Zam Ismail", "Khairiy Rezki Adhinata", "Lionel Pratama Nugroho", "Mahfidz Ardiansyah", "Mohamad Akromul Azam", "Mohammad Ezra Rafiandhika", "Muhammad Akhtar Al Hisyam", "Muhammad Al Fatih", "Muhammad Fatir Albahri", "Muhammad Naufal Rizki", "Muhammad Syamil At Tsauri", "Nauval Abdul Rasyid", "Pranatantra Fachrie", "Rajata Ibnu Faqih", "Reygi Antajun Hikaru", "Rifqi Irfan Hamizan", "Umar Al Jailaani", "Yossa Dzulfi Andrean", "Zahran Sahil", "Rizky Setyo Nugroho", "Teuku Rizqi Mutha"],
                'Kelas 7 B Putra': ["Abidzar Nuha Wafi", "Ach. Raihan Faiz As-Sudaisyi", "Ahmad Nazmu Durori", "Akbar Nurfatah Arsadi", "Akhdan Athaya Putra Zulfikar", "Al Barra Ananta Putra", "Annabighoh Syabanu Gunawan", "Arrais Mahardika Rusli", "Athaya Kaysan Hakim", "Aufa Gilang Pratama", "Bilal Abdul Aslam", "Bintang Dasilva Ibrahim", "Brilliant Alziddan Mustofa", "Denny Maulana Yusuf", "Fathir Muhammad Fadhilah", "Haikal Ahfwan", "Harry Harsya Shiddiq", "Ifan Sofyan", "Kenzie Adelio Tristan", "Khairul Walif", "Luthfirrahman Nafis Hananto", "Muhammad Al-gaza Putra Dewian", "Muhammad Arafa Ekiyano Febrian", "Muhammad Dilfa Fattan", "Muhammad Fahriansyah", "Muhammad Fathan Toriq", "Muhammad Haikal Al Faisya", "Muhammad Najetullah", "Muhammad Raditya Fauzan", "Muhammad Waldan", "Rayhan Faiz Abdillah Hadiyanto", "Sultan Fatih Setiawan", "Zhafran Tata Hidayat"],
                'Kelas 7 A Putri': ["Adara Riyanti", "Aghniya Musamma Harahap", "Ahla Amany Maulidya", "Alivia Zahratukanza", "Alya Ruby Salimah", "Ameera Syahida Ajie", "Asyifa Mahira Lubis", "Bilqis Ghaisani Ahza", "Callysta Lareina Nabiha", "Cordelia Krisna Widyantari", "Deyanna Abigail Baligha Zephania", "Fathya Caliana", "Filzah Ghaisani Fikriyah", "Indhieswara Maharani", "Kanaya Athalla Dzakiyyah", "Kawa'Iba Puti Firmansyah", "Keisha Sahila Az Zahra", "Khansa Ghina Rachmani", "Mehira Mehrnaz Multazam", "Nadiya Fajria Salsabila", "Novilly Azwan", "Putri Mutia Rahmi", "Queenisa Yumna Zahirah", "Rita Madinatul Arofah", "Saffanah Saafia Zahirah", "Shelby Sinar Islamadina", "Shira Rizkia Adara", "Siti Shofa Aulia Rahman", "Syifa Anindya", "Talita Himayatul Kamilah", "Talita Khansa Saputra", "Yukqiu Natasha Ardi", "Zivana Lay"],
                'Kelas 7 B Putri': ["Aesha Bellvania Kirana", "Aira Fitriani Azzahra", "Aisyah Fahira Husna", "Alya Zahra Nabila", "Ameera Isnain Setiadi", "Aulia Zahra Ibrahim", "Azizahtun Nazwa", "Ghina Bilqis Shabreen", "Hafizhah Alimah", "Haninda Aulia Dayana", "Hilma Arifa Aulia Rosid", "Jihan Amira Karim", "Keyla Khanza Ramadhani", "Nafisa Al Mahira", "Nailatisya Aquina Salsabilla", "Nilam Maulina Anggraini", "R A Najeela Putri Widiarsa", "Rhaqueena Aleameccha Alingga", "Salsabila Zovanka", "Shakila Aulia Sakhiy", "Shifa Mumtazah", "Siti Alifia Zahra", "Siti Zahwa Naura Auni", "Siti Ziarra Nur Al-jaelani", "Syafa Savira", "Syakilah Putri Oktavia", "Syakirah Rizqia Ramadani", "Tuhfatun Najwa", "Vinca Fitranavira Putri", "Zhafira Nur Azzahra", "Tiara Izzatunnisa", "Kinara Rahmadania", "Muthiah Lathifah Azzahra", "Avikah Rosafitri"],
            },
            subjects: ["Bahasa Indonesia", "PKn", "Bahasa Inggris", "Matematika", "IPA", "IPS", "Tahsin Tahfizh", "Muhadhoroh", "Tauhid", "Fiqih", "Tafsir", "Hadits", "Tarikh Islam", "Durusul Lughoh", "Mahfuzhot", "Tajwid", "Akhlak Lil Banin", "Muthola'ah", "Khat", "Imla", "Lisan Al Qur'an", "Lisan Bahasa Arab", "Lisan Bahasa Inggris", "Lisan Kitab Kuning", "Lisan Praktik Ibadah"]
        },
        SMA: {
            classes: {
                'Kelas 10 Putra': ["Adhwa Arsya Gatfan", "Afa Zaidan Putra Tamba", "Ahmad Rafli Dhani Muzakki", "Akmal Ihsan Huwaidi", "Albisna Zinata Ababil", "Asyraf Fairuz Mumtaz", "Attiq Muzaki Ibrahim", "Bayanaca Qotthon Elbarca", "Bazyli Rafif Azka", "Charli Andestian", "Danendra Apta Kayana", "Dhafinzha Muhammad Fakhri", "Fasabbi Haqiqie Pramada Rozak", "Irsyad Haitami Fajrin", "Mikail Abdul Majid", "Mochammad Alfath Dhafin", "Muaimar Ghadafi M. Asri", "Muhamad Fairuz Azmi", "Muhamad Rafka Alvaro", "Muhammad Adil Shidqi", "Muhammad Agla Alfathur Rahman", "Muhammad Ammar Muzakki", "Muhammad Azmi", "Muhammad Fahri Alfarizi", "Muhammad Fahri Rosadi", "Muhammad Suryo Nugra Putra Anwar", "Nawwaf Bilza Pakpahan", "Raditya Bustanul Tamam", "Raihan Ramadhan", "Salim Al Habsyi", "Sayyid Aqil Sakhiy Wahyudi", "Yudha Pratama Nurwicaksana Nasution"],
                'Kelas 10 Putri': ["Alfina Dhiya Ulhaq", "Amelinda Nur Febrina", "Amira Azzarine", "Anjeli Ghenia Asmedi", "Aulia Zahra Nursakinah", "Callysta Zhahira", "Citra Aulia Saputra", "Egidhea Sakha Gendis", "Faiha Ulayya", "Kanaya Azzalea Maulida", "Kayla Putri Azzahra", "Kesya Anastasya Putri", "Keysha Hana Alzena", "Khansa Avicenna", "Maia Dina Islamiy Sobariah", "Nailah Saffanah Rizqin", "Najwa Althafunisa", "Nasya Adya Mustafidah", "Raihana Radwa Fahira", "Ratu Syahlina Samlawi", "Siti Aulia Rahma", "Syifa Az Zahra", "Tia Anggrianti", "Ussy Elsinasari", "Vicky Fadilah Luthfiyana", "Virly Evelyn Dean Zahra", "Wildatul Hasanah", "Yolanda Febriani", "Yuha Rizqiyatul Muyassaroh", "Zahiratul Aisyi", "Zulfa Nurul Fauziah"]
            },
            subjects: ["PKn", "Bahasa Indonesia", "Bahasa Inggris", "Matematika", "Biologi", "Fisika", "Kimia", "Ekonomi", "Geografi", "Sosiologi", "Sejarah", "Tahsin Tahfizh", "Muhadhoroh", "Tauhid", "Fiqih", "Tafsir", "Hadits", "Tarikh Islam", "Durusul Lughoh", "Ushul Fiqih", "Nahwu Shorof", "Mahfuzhot", "Khat", "Imla", "Lisan Al Qur'an", "Lisan Bahasa Arab", "Lisan Bahasa Inggris", "Lisan Kitab Kuning", "Lisan Praktik Ibadah"]
        }
    };
    
    // --- PENTING: GANTI DENGAN URL DEPLOYMENT SCRIPT ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFkv8CjPd1u_wM6DWbJZTVA08aAEAyiZRx8QW2U_NFJoVPTfZefYcJzrJnDlH-hTe2Iw/exec"; 

    // Elements
    const levelSelect = document.getElementById('school-level');
    const classSelect = document.getElementById('class-name');
    const subjectSelect = document.getElementById('subject');
    const startInputBtn = document.getElementById('start-input-btn');
    const selectionForm = document.getElementById('selection-form');
    const gradeInputSection = document.getElementById('grade-input-section');
    const gradeInputHeader = document.getElementById('grade-input-header');
    const studentListBody = document.getElementById('student-list-body');
    const changeSelectionBtn = document.getElementById('change-selection-btn');
    const previewBtn = document.getElementById('preview-btn');
    const modal = document.getElementById('preview-modal');
    const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
    
    // Stats Elements
    const statAvg = document.getElementById('stat-avg');
    const statMax = document.getElementById('stat-max');
    const statMin = document.getElementById('stat-min');
    const statFilled = document.getElementById('stat-filled');
    const statTotal = document.getElementById('stat-total');
    const statProgress = document.getElementById('stat-progress');

    // --- Functions ---
    function updateDropdowns() {
        const level = levelSelect.value;
        classSelect.innerHTML = '<option value="">Pilih Kelas...</option>';
        subjectSelect.innerHTML = '<option value="">Pilih Mapel...</option>';
        classSelect.disabled = !level;
        subjectSelect.disabled = !level;
        
        if (level) {
            const data = schoolData[level];
            Object.keys(data.classes).sort().forEach(className => {
                classSelect.add(new Option(className, className));
            });
            data.subjects.sort().forEach(subject => {
                subjectSelect.add(new Option(subject, subject));
            });
        }
        validateSelections();
    }

    function validateSelections() {
        startInputBtn.disabled = !(levelSelect.value && classSelect.value && subjectSelect.value);
    }
    
    function startGradeInput() {
        const level = levelSelect.value;
        const className = classSelect.value;
        const subject = subjectSelect.value;

        if (!level || !className || !subject) return;

        gradeInputHeader.textContent = `Kelas: ${className} | Mapel: ${subject}`;
        
        const students = schoolData[level].classes[className];
        studentListBody.innerHTML = '';
        students.forEach((student, index) => {
            const row = document.createElement('tr');
            row.className = 'table-row-dark';
            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-white/90">${index + 1}</td>
                <td class="px-6 py-4 student-name">${student}</td>
                <td class="px-6 py-4 text-center">
                    <input type="text" class="grade-input w-32 p-2 border rounded-md text-center bg-white/10 text-white placeholder-white/30" placeholder="10-100 atau -">
                </td>
            `;
            studentListBody.appendChild(row);
        });
        
        updateStats();
        selectionForm.classList.add('hidden');
        gradeInputSection.classList.remove('hidden');
    }

    function resetToSelection() {
        gradeInputSection.classList.add('hidden');
        selectionForm.classList.remove('hidden');
        levelSelect.value = '';
        updateDropdowns();
    }
    
    // --- Stats ---
    function updateStats() {
        const inputs = document.querySelectorAll('.grade-input');
        let total = 0;
        let count = 0;
        let filledCount = 0;
        let max = -Infinity;
        let min = Infinity;
        const totalStudents = inputs.length;

        inputs.forEach(input => {
            const val = input.value.trim();
            if (val !== '' && !isNaN(val) && val !== '-') {
                const num = parseFloat(val);
                total += num;
                count++;
                if (num > max) max = num;
                if (num < min) min = num;
            }
            if (val !== '') {
                filledCount++;
            }
        });

        statAvg.textContent = count > 0 ? (total / count).toFixed(1) : '-';
        statMax.textContent = count > 0 ? max : '-';
        statMin.textContent = count > 0 ? min : '-';
        statFilled.textContent = filledCount;
        statTotal.textContent = totalStudents;
        
        const progress = totalStudents > 0 ? (filledCount / totalStudents) * 100 : 0;
        statProgress.style.width = `${progress}%`;
    }

    // --- Highlight Row ---
    function handleFocus(e) {
        if (e.target.classList.contains('grade-input')) {
            const row = e.target.closest('tr');
            if (row) row.classList.add('active-row');
        }
    }

    function handleBlur(e) {
        if (e.target.classList.contains('grade-input')) {
            const row = e.target.closest('tr');
            if (row) row.classList.remove('active-row');
            updateStats(); 
        }
    }
    
    function showPreview() {
        const grades = [];
        let allInputsValid = true;

        document.querySelectorAll('#student-list-body tr').forEach(row => {
            const name = row.querySelector('.student-name').textContent;
            const input = row.querySelector('.grade-input');
            const value = input.value.trim();
            
            const isHyphen = value === '-';
            const isNumeric = !isNaN(value) && value !== '';
            const isNumericValid = isNumeric && Number(value) >= 10 && Number(value) <= 100;

            if (isHyphen || isNumericValid) {
                input.style.borderColor = '';
                input.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
            } else {
                allInputsValid = false;
                input.classList.add('border-red-500', 'ring-2', 'ring-red-500');
            }
            grades.push({ name, value: value === '' ? 'BELUM DIISI' : value });
        });

        if (!allInputsValid) {
            showToast('Harap isi semua nilai (10-100) atau tanda strip (-).', 'error');
            return;
        }

        document.getElementById('preview-details').innerHTML = `
            <p><span class="font-semibold w-32 inline-block text-blue-400">Jenjang</span>: <span class="text-white">${levelSelect.value}</span></p>
            <p><span class="font-semibold w-32 inline-block text-blue-400">Kelas</span>: <span class="text-white">${classSelect.value}</span></p>
            <p><span class="font-semibold w-32 inline-block text-blue-400">Mapel</span>: <span class="text-white">${subjectSelect.value}</span></p>
        `;
        
        const previewTableBody = document.getElementById('preview-table-body');
        previewTableBody.innerHTML = '';
        grades.forEach((grade, index) => {
             previewTableBody.innerHTML += `
                <tr class="table-row-dark">
                    <td class="px-6 py-4 font-medium text-white/90">${index + 1}</td>
                    <td class="px-6 py-4">${grade.name}</td>
                    <td class="px-6 py-4 font-semibold text-white text-center">${grade.value}</td>
                </tr>
             `;
        });
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
    }
    
    function closeModal() {
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function submitData() {
        // Collect data before closing modal
        const className = classSelect.value;
        const subject = subjectSelect.value;
        const gradesData = Array.from(document.querySelectorAll('#student-list-body tr')).map(row => ({
            studentName: row.querySelector('.student-name').textContent,
            grade: row.querySelector('.grade-input').value
        }));

        const payload = {
            className: className,
            subject: subject,
            grades: gradesData
        };
        
        setLoadingState(true);
        // Do NOT reset selection yet, keep data in memory
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            
            if (result.result === 'success') {
                showToast('Nilai berhasil dikirim!');
                closeModal();
                resetToSelection(); // Only reset after success
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showToast(`Gagal: ${error.message}`, 'error');
            setLoadingState(false); // Re-enable button on error
        }
    }

    function setLoadingState(isLoading) {
        const btn = document.getElementById('confirm-submit-btn');
        const txt = document.getElementById('submit-text');
        const spinner = document.getElementById('submit-spinner');
        if (isLoading) {
            btn.disabled = true;
            txt.classList.add('hidden');
            spinner.classList.remove('hidden');
        } else {
            btn.disabled = false;
            txt.classList.remove('hidden');
            spinner.classList.add('hidden');
        }
    }

    let toastTimeout;
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        clearTimeout(toastTimeout);
        toast.textContent = message;
        toast.className = 'fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform transition-transform duration-500 z-50';
        
        if (type === 'error') toast.classList.add('bg-red-600');
        else if (type === 'info') toast.classList.add('bg-blue-600');
        else toast.classList.add('bg-green-600');
        
        toast.classList.remove('translate-x-[150%]'); // Show
        toastTimeout = setTimeout(() => toast.classList.add('translate-x-[150%]'), 4000); // Hide
    }

    // --- Event Listeners ---
    levelSelect.addEventListener('change', updateDropdowns);
    classSelect.addEventListener('change', validateSelections);
    subjectSelect.addEventListener('change', validateSelections);
    startInputBtn.addEventListener('click', startGradeInput);
    changeSelectionBtn.addEventListener('click', resetToSelection);
    previewBtn.addEventListener('click', showPreview);
    
    // Focus & Input Listeners
    studentListBody.addEventListener('focusin', handleFocus);
    studentListBody.addEventListener('focusout', handleBlur);
    studentListBody.addEventListener('input', (e) => {
        if (e.target.classList.contains('grade-input')) updateStats();
    });

    // Modal listeners
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    document.getElementById('cancel-btn').addEventListener('click', closeModal);
    confirmSubmitBtn.addEventListener('click', submitData);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
});
</script>
</body>
</html>
